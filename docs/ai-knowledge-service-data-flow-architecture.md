# AI 知识服务 - 数据流主线架构

> 本文档定义 AI 知识服务的核心数据流主线，作为后续各节点细化设计的框架基础。

---

## 一、主线概览

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  Source  │───▶│ 采集管道  │───▶│Raw Files │───▶│ 索引管道  │───▶│ Indexes  │
│  数据源   │    │Ingestion │    │ 原始文件  │    │ Indexing │    │  索引库   │
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
                                                                      │
                                                                      │
┌──────────┐    ┌──────────┐                                          │
│   API    │◀───│ 查询管道  │◀─────────────────────────────────────────┘
│  服务层   │    │  Query   │
└──────────┘    └──────────┘
```

**数据流向**：
- **写入路径**：Source → 采集管道 → Raw Files → 索引管道 → Indexes
- **读取路径**：API 服务 → 查询管道 → Indexes

---

## 二、节点定义

### 2.1 Source（数据源）

**定位**：知识的原始来源，系统的输入边界。

**职责**：
- 定义知识可以从哪些渠道进入系统
- 明确每种来源的数据形态和接入方式

**输出**：原始数据（文件、文本、记录等）

**待细化内容**：
- [ ] 支持的数据源类型清单
- [ ] 各类型数据源的接入协议
- [ ] 数据源的元信息定义

---

### 2.2 采集管道（Ingestion Pipeline）

**定位**：数据入口的统一网关，负责将多样化的外部数据转化为系统内部的标准形态。

**职责**：
- 接收来自各数据源的原始数据
- 执行初步校验（格式、大小、安全性）
- 生成唯一标识
- 提取基础元信息
- 将数据写入 Raw Files 存储

**输入**：来自 Source 的原始数据

**输出**：标准化的原始文件记录

**关键特性**：
- 无状态：同一输入多次执行应产生相同结果
- 幂等性：重复提交不产生副作用
- 可重试：失败可安全重试

**待细化内容**：
- [ ] 采集流程的详细步骤
- [ ] 校验规则定义
- [ ] 元信息提取规范
- [ ] 异常处理策略

---

### 2.3 Raw Files（原始文件存储）

**定位**：系统的事实源头（Source of Truth），保存所有进入系统的原始数据。

**职责**：
- 持久化存储原始文件内容
- 维护原始文件的元数据记录
- 保证数据的不可变性和可追溯性

**输入**：来自采集管道的标准化数据

**输出**：供索引管道读取的原始内容

**关键特性**：
- 只写不改：数据一旦写入，内容不可修改
- 完整保留：即使标记删除，原始记录永久保存
- 可寻址：每份数据都有唯一标识，可精确定位

**数据结构**：
| 字段 | 说明 |
|-----|------|
| 文件标识 | 全局唯一ID |
| 来源类型 | 标识数据来自哪类 Source |
| 原始名称 | 数据的原始命名 |
| 内容指纹 | 内容的唯一校验值 |
| 存储位置 | 物理存储路径 |
| 所属知识库 | 归属的逻辑知识库 |
| 生命周期状态 | 活跃/归档/已删除 |
| 创建时间 | 进入系统的时间 |

**待细化内容**：
- [ ] 存储策略（物理组织方式）
- [ ] 元数据完整字段定义
- [ ] 生命周期管理规则
- [ ] 与知识库的关联关系

---

### 2.4 索引管道（Indexing Pipeline）

**定位**：数据加工中心，将原始文件转化为可高效检索的索引形态。

**职责**：
- 读取 Raw Files 中的原始内容
- 解析、清洗、转换数据
- 生成多种类型的索引
- 将索引写入对应的 Indexes 存储

**输入**：Raw Files 中的原始文件

**输出**：写入各类索引存储的索引数据

**关键特性**：
- 多路输出：一份原始文件可生成多种索引
- 任务驱动：由构建任务触发，而非直接监听 Raw Files
- 支持全量/增量：可处理全部数据或仅处理变更部分

**待细化内容**：
- [ ] 索引处理的详细流程
- [ ] 支持的索引类型定义
- [ ] 全量与增量构建的触发机制
- [ ] 构建任务的管理模型
- [ ] 版本控制策略

---

### 2.5 Indexes（索引库）

**定位**：检索优化的数据存储，为不同查询模式提供高效的数据访问能力。

**职责**：
- 存储由索引管道生成的各类索引数据
- 提供高效的检索接口
- 支持版本隔离

**输入**：来自索引管道的索引数据

**输出**：响应查询管道的检索请求

**索引类型**：
| 类型 | 特点 | 适用场景 |
|-----|------|---------|
| 结构化索引 | 字段精确匹配 | 条件过滤、精确查询 |
| 文本索引 | 文件/目录组织 | 路径定位、全文获取 |
| 语义索引 | 相似度匹配 | 模糊搜索、语义理解 |

**关键特性**：
- 多模态：支持多种索引类型并存
- 版本化：同一知识库可存在多个版本的索引
- 独立伸缩：各类索引可独立扩展

**待细化内容**：
- [ ] 各索引类型的详细定义
- [ ] 索引的数据结构规范
- [ ] 版本管理机制
- [ ] 索引的生命周期

---

### 2.6 查询管道（Query Pipeline）

**定位**：检索执行引擎，将查询请求转化为对索引库的精确访问。

**职责**：
- 接收来自 API 服务的查询请求
- 解析查询参数（目标知识库、查询类型、版本等）
- 路由到对应的索引存储
- 执行检索操作
- 整合并返回标准化结果

**输入**：来自 API 服务的查询请求

**输出**：标准化的查询结果集

**关键特性**：
- 类型感知：根据查询类型选择对应的索引
- 版本感知：根据版本参数定位正确的索引版本
- 结果标准化：无论底层索引类型，返回统一格式

**待细化内容**：
- [ ] 查询请求的参数规范
- [ ] 查询类型与索引的映射关系
- [ ] 结果的标准格式定义
- [ ] 查询路由策略

---

### 2.7 API 服务（API Service）

**定位**：系统的对外边界，为上层应用提供统一的知识访问接口。

**职责**：
- 暴露标准化的查询接口
- 处理身份认证与权限校验
- 转发请求至查询管道
- 封装并返回响应

**输入**：来自上层应用的 HTTP/RPC 请求

**输出**：标准化的 API 响应

**关键特性**：
- 协议标准：提供规范的接口契约
- 安全边界：所有访问必须经过认证授权
- 无业务逻辑：纯粹的请求转发与响应封装

**待细化内容**：
- [ ] API 接口定义
- [ ] 认证授权机制
- [ ] 请求/响应格式规范
- [ ] 错误码定义

---

## 三、节点间的边界与契约

### 3.1 Source → 采集管道

| 项目 | 说明 |
|-----|------|
| 触发方式 | 推送（主动上传）/ 拉取（定时采集） |
| 传递内容 | 原始数据 + 来源标识 + 基础元信息 |
| 契约 | 待定义：各数据源的接入规范 |

### 3.2 采集管道 → Raw Files

| 项目 | 说明 |
|-----|------|
| 触发方式 | 采集管道主动写入 |
| 传递内容 | 原始文件内容 + 标准化元数据 |
| 契约 | 待定义：元数据字段规范 |

### 3.3 Raw Files → 索引管道

| 项目 | 说明 |
|-----|------|
| 触发方式 | 构建任务驱动（非直接监听） |
| 传递内容 | 文件标识列表 + 任务上下文 |
| 契约 | 待定义：构建任务的输入规范 |

### 3.4 索引管道 → Indexes

| 项目 | 说明 |
|-----|------|
| 触发方式 | 索引管道主动写入 |
| 传递内容 | 索引数据 + 版本标识 + 溯源信息 |
| 契约 | 待定义：各类索引的写入规范 |

### 3.5 API 服务 → 查询管道

| 项目 | 说明 |
|-----|------|
| 触发方式 | API 请求触发 |
| 传递内容 | 查询参数（知识库、查询文本、类型、版本等） |
| 契约 | 待定义：查询请求规范 |

### 3.6 查询管道 → Indexes

| 项目 | 说明 |
|-----|------|
| 触发方式 | 查询管道主动读取 |
| 传递内容 | 检索条件 + 版本约束 |
| 契约 | 待定义：各类索引的查询接口 |

---

## 四、横切关注点

以下内容贯穿整个主线，需要在各节点细化时统一考虑：

### 4.1 知识库（Knowledge Base）

- 逻辑容器，贯穿 Raw Files → Indexes 全链路
- 权限控制的基本单元
- 所有数据都归属于某个知识库

### 4.2 版本管理

- 覆盖范围：索引管道 → Indexes → 查询管道
- 核心概念：逻辑版本、构建任务、版本切换

### 4.3 任务管理

- 覆盖范围：Raw Files → 索引管道 → Indexes
- 核心概念：构建任务、任务输入、任务状态

### 4.4 溯源追踪

- 贯穿全链路
- 任何查询结果都能追溯到：索引版本 → 构建任务 → 原始文件 → 数据源

### 4.5 权限控制

- 入口：API 服务层
- 控制粒度：知识库级别

---

## 五、后续细化计划

| 序号 | 节点 | 细化文档 | 状态 |
|-----|------|---------|------|
| 1 | Source | 数据源类型与接入规范 | 待编写 |
| 2 | 采集管道 | 采集流程与处理规范 | 待编写 |
| 3 | Raw Files | 原始文件存储设计 | 待编写 |
| 4 | 索引管道 | 索引构建流程与任务管理 | 待编写 |
| 5 | Indexes | 索引类型与存储规范 | 待编写 |
| 6 | 查询管道 | 查询处理与路由策略 | 待编写 |
| 7 | API 服务 | 接口定义与协议规范 | 待编写 |
| 8 | 横切关注点 | 知识库/版本/任务/溯源/权限 | 待编写 |

---

## 六、文档版本

| 版本 | 日期 | 说明 |
|-----|------|------|
| 0.1 | 2026-01-07 | 初稿，定义主线框架 |
